<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSD Inventory Management Dashboard</title>
    <link href="./bootstrap-icons/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./bootstrap-icons/bootstrap-icons.min.css">
    <!--<script src="./js/chart.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="custom-scrollbars.css">
    <script src="./bootstrap-icons/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --primary-dark-bg: #2b2d30;
            --secondary-dark-bg: #3c3f41;
            --accent-blue: #0078d7;
            --text-color-light: #ffffff;
            --text-color-dark: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-color: rgba(255, 255, 255, 0.15);
        }

        /* Light Theme Variables */
        body.light-theme {
            --primary-dark-bg: #ffffff;
            --secondary-dark-bg: #f5f5f5;
            --accent-blue: #0078d7;
            --text-color-light: #333333;
            --text-color-dark: #111111;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --border-color: rgba(0, 0, 0, 0.1);
            background-color: #fafafa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #3b3e40; /* General background, slightly lighter than --primary-dark-bg */
            color: var(--text-color-dark); /* Default text color */
            padding: 20px; /* Add some padding to the body for content spacing */
        }

        .dashboard-header {
            background-color: var(--primary-dark-bg);
            color: var(--text-color-light);
            padding: 20px; /* Adjusted padding */
            margin-bottom: 30px;
            border-radius: 8px; /* Slightly rounded corners for the header */
            box-shadow: 0 5px 15px var(--shadow-color); /* More pronounced shadow */
            text-align: center; /* Center the header text */
        }

            .dashboard-header h1 {
                color: var(--text-color-light); /* Ensure header H1 is white */
                font-weight: 600; /* Make title a bit bolder */
            }

            .dashboard-header .lead {
                color: rgba(255, 255, 255, 0.8); /* Slightly dim the lead text */
            }

        .card {
            border-radius: 8px; /* Consistent rounded corners */
            box-shadow: 0 4px 10px var(--shadow-color); /* Slightly softer shadow for cards */
            margin-bottom: 20px;
            border: 1px solid var(--border-color); /* Subtle border */
            background-color: var(--secondary-dark-bg); /* Dark background for cards */
            color: var(--text-color-dark); /* Text color for card content */
        }

        .card-header {
            background-color: var(--primary-dark-bg); /* Darker header for cards */
            color: var(--text-color-light);
            border-radius: 7px 7px 0 0 !important; /* Adjust radius to match card */
            padding: 15px; /* Add padding to card header */
            border-bottom: 1px solid var(--border-color); /* Separator for card header */
            font-weight: 500; /* Make card header title a bit bolder */
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2.8rem; /* Slightly larger for impact */
            font-weight: bold;
            color: var(--accent-blue); /* Use our accent blue */
            margin-bottom: 5px; /* Space between value and label */
        }

        .metric-label {
            color: var(--text-color-dark); /* Use slightly darker text color */
            font-size: 1.1rem; /* Slightly larger font */
            opacity: 0.9; /* Increased opacity for better readability */
            font-weight: 500; /* Make label a bit bolder */
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px; /* Slightly more space */
            vertical-align: middle; /* Align with text */
        }

        /* Keep these status colors as they are standard indicators */
        .status-active {
            background-color: #2ecc71; /* Green */
        }

        .status-inactive {
            background-color: #e74c3c; /* Red */
        }

        .status-pending {
            background-color: #f39c12; /* Orange */
        }

        .recent-activity-item {
            border-left: 3px solid var(--accent-blue); /* Use accent blue for highlight */
            padding-left: 15px;
            margin-bottom: 15px;
            background-color: rgba(255, 255, 255, 0.08); /* Slightly more visible highlight for the item itself */
            padding-top: 10px;
            padding-bottom: 10px;
            border-radius: 4px;
        }

            .recent-activity-item p {
                margin: 0; /* Remove default paragraph margin */
                line-height: 1.5; /* Improve readability */
            }

            .recent-activity-item .text-muted {
                color: rgba(255, 255, 255, 0.6) !important; /* Make muted text more visible */
            }

        /* Bootstrap-like pills if you're using them */
        .nav-pills .nav-link {
            color: var(--text-color-dark); /* Default pill text */
            background-color: var(--secondary-dark-bg); /* Default pill background */
            transition: background-color 0.2s, color 0.2s;
        }

            .nav-pills .nav-link:hover {
                background-color: rgba(255, 255, 255, 0.15); /* Hover for pills, slightly stronger */
            }

            .nav-pills .nav-link.active {
                background-color: var(--accent-blue); /* Active pill background */
                color: var(--text-color-light); /* Active pill text */
            }

        /* Adjustments for Bootstrap badges */
        .badge {
            font-weight: 500; /* Make badge text a bit bolder */
        }

            .badge.bg-light { /* Override for bg-light badge to make text visible on dark theme */
                background-color: rgba(255, 255, 255, 0.15) !important; /* A light background for the badge */
                color: var(--text-color-light) !important; /* White text for the badge */
                border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border for definition */
            }

        /* Bootstrap alert overrides for dark theme */
        .alert {
            color: var(--text-color-dark); /* Default alert text color */
            border: 1px solid;
            background-color: transparent; /* Remove default alert background */
        }

        .alert-warning {
            border-color: #f39c12; /* Orange border */
            background-color: rgba(243, 156, 18, 0.2); /* Subtle orange background */
            color: #f39c12; /* Orange text */
        }

        .alert-danger {
            border-color: #e74c3c; /* Red border */
            background-color: rgba(231, 76, 60, 0.2); /* Subtle red background */
            color: #e74c3c; /* Red text */
        }

        .alert-info {
            border-color: #3498db; /* Blue border */
            background-color: rgba(52, 152, 219, 0.2); /* Subtle blue background */
            color: #FFFFFF; /* White text */
        }

        .alert-success {
            border-color: #2ecc71; /* Green border */
            background-color: rgba(46, 204, 113, 0.2); /* Subtle green background */
            color: #2ecc71; /* Green text */
        }

        .alert strong {
            color: var(--text-color-light); /* Make strong text in alerts bright white */
        }


        /* Chart.js specific styling for dark theme */
        canvas {
            background-color: var(--primary-dark-bg); /* Dark background for charts */
            border-radius: 5px;
            padding: 10px;
        }

        .chartjs-render-monitor { /* Specific to Chart.js, ensure it respects sizing */
            width: 100% !important;
            height: auto !important;
        }


        /* Table styling for dark theme */
        .table {
            --bs-table-bg: var(--secondary-dark-bg); /* Table background */
            --bs-table-color: var(--text-color-dark); /* Table text color */
            --bs-table-border-color: var(--border-color); /* Table border color */
            --bs-table-striped-bg: #323537; /* Striped row background */
            --bs-table-hover-bg: rgba(255, 255, 255, 0.08); /* Hover row background */
        }

            .table th {
                color: var(--text-color-light); /* Table header text color */
                border-bottom-color: var(--border-color);
            }

            .table td {
                border-bottom-color: var(--border-color);
            }

        /* Chart.js Tooltip overrides */
        .chartjs-tooltip {
            background-color: rgba(0, 0, 0, 0.8) !important;
            border-radius: 5px !important;
            color: var(--text-color-light) !important;
        }

        .custom-dark-modal {
            background-color: var(--secondary-dark-bg); /* Match your cards */
            color: var(--text-color-dark);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

            /* Ensure modal header uses same dark style */
            .custom-dark-modal .modal-header {
                background-color: var(--primary-dark-bg);
                color: var(--text-color-light);
                border-bottom: 1px solid var(--border-color);
            }

            /* Optional: Modal footer if you add one later */
            .custom-dark-modal .modal-footer {
                background-color: var(--primary-dark-bg);
                border-top: 1px solid var(--border-color);
            }

        /* Close button white */
        .btn-close-white {
            filter: invert(1);
        }

        /* Modal table inherits table theme */
        .custom-dark-modal .table {
            --bs-table-bg: var(--secondary-dark-bg);
            --bs-table-color: var(--text-color-dark);
            --bs-table-border-color: var(--border-color);
            --bs-table-striped-bg: #323537;
            --bs-table-hover-bg: rgba(255, 255, 255, 0.08);
        }
        /* Override any accidental blue text usage */
        *[style*="color: var(--accent-blue)"] {
            color: var(--text-color-dark) !important;
        }

        .card-body {
            overflow-x: auto;
        }

        #inventoryPieChart {
            width: 100% !important;
            height: 100% !important;
        }

        #inventoryRubberdieChart {
            width: 100% !important;
            height: 100% !important;
        }

        #inventoryPrintcardChart {
            width: 100% !important;
            height: 100% !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--text-color-light); /* White text for dark theme */
        }

        .chart-container {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--secondary-dark-bg); /* Darker card background */
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--shadow-color); /* Stronger shadow for depth */
            border: 1px solid var(--border-color); /* Subtle border */
        }

        canvas {
            max-width: 100%; /* Prevent overflow */
            max-height: 400px; /* Fixed height to avoid resizing issues */
            background-color: var(--primary-dark-bg); /* Dark chart background */
            border: 1px solid var(--border-color); /* Subtle border for visibility */
            border-radius: 5px;
        }

        #debugOutput {
            margin-top: 20px;
            padding: 10px;
            background-color: #333; /* Slightly darker than secondary background */
            border: 1px solid var(--border-color); /* Consistent border */
            color: var(--text-color-light); /* White text for readability */
            white-space: pre-wrap;
            max-height: 200px;
            /* limit height*/
            max-height: 40px;
            overflow-y: auto;
        }

        select#yearSelect {
            background-color: var(--secondary-dark-bg);
            color: var(--text-color-light);
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

            select#yearSelect:focus {
                outline: none;
                border-color: var(--accent-blue);
            }

        #themeToggle {
            border: 1px solid var(--border-color);
            color: var(--text-color-light);
        }

            #themeToggle:hover {
                background-color: rgba(0,0,0,0.05);
            }

        body.light-theme #themeToggle:hover {
            background-color: rgba(0,0,0,0.1);
        }

        body.light-theme #themeToggle {
            border: 1px solid #666; /* Dark grey border for light theme */
            color: #333; /* Dark text/icon for light theme */
        }

        #themeToggle i {
            color: inherit;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">

            <div class="row">
                <div class="col-md-8">
                    <h1><i class="bi bi-box-seam"></i> TSD Inventory Management System</h1>
                    <p class="lead">Dashboard for Printcard, Rubberdie, and Diecut inventory</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark">Last updated: <span id="lastUpdated">Loading...</span></span>
                    <button id="themeToggle" class="btn btn-sm btn-outline-light ms-2">
                        <i id="themeIcon" class="bi bi-moon"></i>
                    </button>
                </div>
            </div>

        </div>       
    </div>

    <div class="container">
        <!-- Quick Stats Row -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalPrintcardsValue"></div>
                    <div class="metric-label">Total Printcards</div>
                    <div class="mt-2">
                        <span class="badge bg-success" id="totalPrintcardsBadgeWeek">+0 this week</span>
                        <span class="badge bg-success" id="totalPrintcardsBadgeMonth">+0 this month</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalRubberdies">0</div>
                    <div class="metric-label">Active Rubberdies</div>
                    <div class="mt-2">
                        <span class="badge bg-warning text-dark" id="totalRubberdieToExpire">0 expiring soon</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalDiecutMould">0</div>
                    <div class="metric-label">Diecut Moulds</div>
                    <div class="mt-2">
                        <span class="badge bg-danger " id="totalDiecutOverdueMaintenance">0 overdue for maintenance</span>
                    </div>
                    <div class="mt-2">
                        <span class="badge bg-warning-subtle text-dark" id="totalDiecutInMaintenance"></span>
                        <span class="badge bg-info-subtle text-dark" id="totalDisposed"> Total disposed diecut moulds</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalRequests"></div>
                    <div class="metric-label">Requests for the past 1 Year</div>
                    <div class="mt-2">
                        <span class="badge bg-info" id="totalPendingRequests"></span>
                        <span class="badge bg-info" id="totalHighPriorityRequests"></span>
                        <span class="badge bg-info" id="totalInDevelopmentRequests"></span>
                        <span class="badge bg-info" id="totalInCompletedRequests"></span>                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row mt-4">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Inventory Status Chart -->
                <!--<div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Inventory Status Overview</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="inventoryChart" height="250"></canvas>
                    </div>
                </div>-->
                <div class="chart-container">
                    <h4>Inventory Status Overview</h4>
                    <select id="yearSelect" onchange="onYearChange()">
                        <!-- Years populated dynamically -->
                    </select>
                    <canvas id="inventoryChart"></canvas>
                    <div id="debugOutput"></div>
                </div>

                <!-- Recent Requests -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Recent Requests(Last 6 weeks)</h5>
                        <div>
                            <button id="viewAllRecentRequests" class="btn btn-sm btn-outline-light">View All</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="recentRequests" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Requisition #</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4">
                <!-- Inventory Alerts -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Inventory Alerts</h5>
                    </div>
                    <div class="card-body">

                        <div class="alert alert-success" id="thisWeekCompleted">
                        </div>

                        <div class="alert alert-warning" id="diecutsUsageLimitReached">
                            <strong></strong>
                        </div>

                        <div class="alert alert-warning" id="rubberdiesUsageLimitReached">
                        </div>
                    </div>
                </div>

                <!-- Rubberdie Modal -->
                <div class="modal fade" id="rubberdieModal" tabindex="-1" aria-labelledby="rubberdieModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content custom-dark-modal">
                            <div class="modal-header">
                                <h5 class="modal-title" id="rubberdieModalLabel">Rubber Die Usage Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Rubber ID</th>
                                            <th>Description</th>
                                            <th>Customer</th>
                                            <th>Current Usage</th>
                                            <th>Requested Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rubberdieTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Diecut Modal -->
                <div class="modal fade" id="diecutModal" tabindex="-1" aria-labelledby="diecutModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content custom-dark-modal">
                            <div class="modal-header">
                                <h5 class="modal-title" id="diecutModalLabel">Diecut Usage Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Rubber ID</th>
                                            <th>Description</th>
                                            <th>Customer</th>
                                            <th>Current Usage</th>
                                            <th>Machine</th>
                                            <th>Requested Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="diecutTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Distribution -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Diecut Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="inventoryPieChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Rubberdie Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="inventoryRubberdieChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Printcard Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="inventoryPrintcardChart"></canvas>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>


        document.addEventListener("DOMContentLoaded", function () {
            tryLoadRecentRequests();
            console.log("DOM fully loaded");
            const viewAllBtn = document.getElementById('viewAllRecentRequests');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', tryLoadRecentRequests);
                //console.log("WebView2 message received", event.data);
            }
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');

            // Load saved theme
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.classList.replace('bi-moon', 'bi-sun');
            }

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('light-theme');
                updateChartColors();
                const isLight = document.body.classList.contains('light-theme');
                themeIcon.classList.toggle('bi-moon', !isLight);
                themeIcon.classList.toggle('bi-sun', isLight);
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
            });
        });

        let pieChart;
        // Set last updated time
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

        Chart.defaults.color = '#FFFFFF';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';

        function renderDiecutPie(labels, counts) {
            const ctx = document.getElementById('inventoryPieChart').getContext('2d');

            /* destroy previous instance if you refresh data */
            if (window.diecutChart) { window.diecutChart.destroy(); }

            window.diecutChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        /* Chart.js will auto‑assign colours; override if you want */
                        backgroundColor: [
                            '#0078d7', '#2ecc71', '#e74c3c', '#f39c12',
                            '#9b59b6', '#3498db', '#95a5a6'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e0e0e0' }      // dark theme text
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${ctx.parsed}`
                            }
                        }
                    }
                }
            });
        }

        function renderRubberdiePie(labels, counts) {
            const ctx = document.getElementById('inventoryRubberdieChart').getContext('2d');

            /* destroy previous instance if you refresh data */
            if (window.rubberdieChart) { window.rubberdieChart.destroy(); }

            window.rubberdieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        /* Chart.js will auto‑assign colours; override if you want */
                        backgroundColor: [
                            '#0078d7', '#2ecc71', '#e74c3c', '#f39c12',
                            '#9b59b6', '#3498db', '#95a5a6'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e0e0e0' }      // dark theme text
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${ctx.parsed}`
                            }
                        }
                    }
                }
            });
        }

        function renderPrintcardPie(labels, counts) {
            const ctx = document.getElementById('inventoryPrintcardChart').getContext('2d');

            /* destroy previous instance if you refresh data */
            if (window.printcardChart) { window.printcardChart.destroy(); }

            window.printcardChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        /* Chart.js will auto‑assign colours; override if you want */
                        backgroundColor: [
                            '#0078d7', '#2ecc71', '#e74c3c', '#f39c12',
                            '#9b59b6', '#3498db', '#95a5a6'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e0e0e0' }      // dark theme text
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${ctx.parsed}`
                            }
                        }
                    }
                }
            });
        }

        function tryLoadRecentRequests() {
            const tbody = document.querySelector('#recentRequests tbody');

            if (!tbody) {
                console.warn("Table body not yet available. Retrying...");
                setTimeout(tryLoadRecentRequests, 100);
                return;
            }

            if (window.chrome && chrome.webview?.hostObjects?.dashboardApi) {
                chrome.webview.hostObjects.dashboardApi.GetRecentRequests().then(function (json) {
                    const data = JSON.parse(json);
                    tbody.innerHTML = '';

                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                <td>${row.requisition_number || ''}</td>
                                <td>${row.request_type || ''}</td>
                                <td>${row.customer || ''}</td>
                                <td>${row.status || ''}</td>
                                <td>${row.due_date || ''}</td>`;
                        tbody.appendChild(tr);
                    });
                }).catch(err => {
                    console.error("Failed to load recent requests:", err);
                });
            } else {
                console.warn("dashboardApi not yet ready. Retrying...");
                setTimeout(tryLoadRecentRequests, 100);
            }
        }

        // Function to update a specific metric card value
        function updateMetricValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                // Use toLocaleString for number formatting (e.g., adding commas)
                element.textContent = value.toLocaleString();
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }
        // NEW: Function to update the badge text
        function updateMetricBadgeThisWeek(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} this week`; // Format the text as "+[value] this week"
                // Optional: Change badge color based on value, e.g., if 0, make it secondary
                if (value > 0) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger'); // Remove other possible states
                    element.classList.add('bg-success');
                } else {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-secondary'); // Neutral color if no items added this week
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        // NEW: Function to update the badge text
        function updateMetricBadgeThisMonth(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} this month`; // Format the text as "+[value] this week"
                // Optional: Change badge color based on value, e.g., if 0, make it secondary
                if (value > 0) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger'); // Remove other possible states
                    element.classList.add('bg-success');
                } else {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-secondary'); // Neutral color if no items added this week
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateMetricPendingRequests(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} pending requests`; // Format the text as "+[value] this week"
                // Optional: Change badge color based on value, e.g., if 0, make it secondary
                if (value > 0) {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-warning');
                } else {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-success');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateHighPriorityRequests(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} high priority`;
                if (value > 0) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-danger');
                } else {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-secondary');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateInDevelopmentRequests(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} In Development`;
                if (value > 0) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-warning');
                } else {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-secondary');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateChartColors() {
            Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--text-color-dark');
            Chart.defaults.borderColor = getComputedStyle(document.body).getPropertyValue('--border-color');
            if (inventoryChart) inventoryChart.update();
        }

        function updateTotalDisposedDiecuts(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} total disposed diecut moulds`;                 
                if (value > 0) {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-success');
                } else {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-success');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateCompletedRequests(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} Completed`;
                if (value > 0) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-success');
                } else {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-secondary');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateCompletedThisWeek(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<strong>+${value} Requests</strong> completed this week.`;
                if (value > 0) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-success');
                } else {
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-secondary');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function updateDiecutUsageLimit(elementId, value, data = []) {
            const element = document.getElementById(elementId);
            if (element) {
                if (value > 0) {
                    element.innerHTML = `<strong><a href="#" class="link-light" onclick='showDiecutModal(${JSON.stringify(data)})'>${value} diecut mould(s)</a></strong> have reached over 80% of their usage limit or have reached their aging limit.`;
                    element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-danger');
                } else {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-success');
                    element.textContent = "No diecut moulds nearing usage limit.";
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }
        function showDiecutModal(data) {
            const tbody = document.getElementById("diecutTableBody");
            tbody.innerHTML = "";

            data.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                            <td>${row.diecut_id}</td>
                            <td>${row.description}</td>
                            <td>${row.customer}</td>
                            <td>${row.current_usage}</td>
                            <td>${row.machine} </td>
                            <td>${row.requested_date} </td> `;
                tbody.appendChild(tr);
            });

            const modal = new bootstrap.Modal(document.getElementById('diecutModal'));
            modal.show();
        }

        function updateRubberdieUsageLimit(elementId, value, data = []) {
            const element = document.getElementById(elementId);
            if (!element) {
                alert(`Element with ID '${elementId}' not found.`);
                return;
            }
            if (value > 0) {
                element.innerHTML = `<strong><a href="#" class="link-light" onclick='showRubberdieModal(${JSON.stringify(data)})'>${value} Rubberdie(s)</a></strong> have reached over 80% of their usage limit or have reached their aging limit.`;
                element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
                element.classList.add('bg-danger');
            } else {
                element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                element.classList.add('bg-success');
                element.textContent = "No rubberdie plates nearing usage limit.";
            }
        }
        function updateDiecutInMaintenance(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `+${value} In Maintenance`;
                if (value > 0 && value < 5) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger');
                    element.classList.add('bg-danger-subtle');
                } else if (value >= 5) {
                    element.classList.remove('bg-secondary', 'bg-warning', 'bg-danger-subtle');
                    element.classList.add('bg-danger');
                } else {
                    element.classList.remove('bg-secondary', 'bg-danger-subtle', 'bg-danger');
                    element.classList.add('bg-success');
                }
            } else {
                console.warn(`Element with ID '${elementId}' not found.`);
            }
        }

        function showRubberdieModal(data) {
            const tbody = document.getElementById("rubberdieTableBody");
            tbody.innerHTML = "";

            data.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                        <td>${row.rubber_id}</td>
                        <td>${row.description}</td>
                        <td>${row.customer}</td>
                        <td>${row.current_usage}</td>
                        <td>${row.requested_date}  </td>  `;
                tbody.appendChild(tr);
            });

            const modal = new bootstrap.Modal(document.getElementById('rubberdieModal'));
            modal.show();
        }

        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            document.getElementById('debugOutput').textContent += `\n${new Date().toISOString()}: Error: Chart.js not loaded`;
        } else {
            document.getElementById('debugOutput').textContent += `\n${new Date().toISOString()}: Chart.js loaded successfully`;
        }

        // Global chart instance
        let inventoryChart;

        // Function to log debug messages
        function logDebug(message) {
            const debugDiv = document.getElementById('debugOutput');
            debugDiv.textContent += `\n${new Date().toISOString()}: ${message}`;
        }

        function populateYearDropdown() {
            const select = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear(); // 2025
            for (let year = currentYear; year >= 2005; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.text = year;
                select.appendChild(option);
            }

            select.value = currentYear; // Default to 2024
            logDebug(`Year dropdown populated, default year: ${select.value}`);
        }

        function onYearChange() {
            const year = document.getElementById('yearSelect').value;
            logDebug(`Year changed to: ${year}`);
            // Send message to C# to fetch data for the selected year
            try {
                window.chrome.webview.postMessage({ type: 'fetchYearData', year: parseInt(year) });
            } catch (error) {
                logDebug(`Error sending message to C#: ${error.message}`);
            }
        }

        // Function to initialize or update the chart
        function updateInventoryChart(data, year) {
            try {
                //logDebug(`Received data: ${JSON.stringify(data, null, 2)}`);
                //logDebug(`Received data for year ${year}: ${JSON.stringify(data, null, 2)}`);
                const ctx = document.getElementById('inventoryChart').getContext('2d');
                if (!ctx) {
                    //logDebug('Error: Canvas context not found');
                    return;
                }

                // Destroy existing chart if it exists
                if (inventoryChart) {
                    inventoryChart.destroy();
                    //logDebug('Destroyed previous chart instance');
                }

                // Validate data
                const labels = (data && data.labels && Array.isArray(data.labels)) ? data.labels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const datasets = (data && data.datasets && Array.isArray(data.datasets)) ? data.datasets : [
                    {
                        label: 'Rubberdie Plates',
                        data: new Array(12).fill(0),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Diecut Tools',
                        data: new Array(12).fill(0),
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Printcards',
                        data: new Array(12).fill(0),
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ];

                // Create new chart
                inventoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true
                                }
                            },
                            x: {
                                title: {
                                    display: true
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: `Monthly Inventory Creation (${year || 2024})` // Dynamic year, fallback to 2024
                            }
                        }
                    }
                });
                //logDebug('Chart initialized successfully');
            } catch (error) {
                logDebug(`Chart update error: ${error.message}`);
            }
        }

        populateYearDropdown();
        // Initialize chart with default data on page load
        updateInventoryChart(null, 2024);

        // Log when script loads
        //logDebug('JavaScript loaded');

    </script>
</body>
</html>
