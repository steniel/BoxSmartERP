<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printcard Inventory</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" href="./bootstrap-icons/bootstrap-icons.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
    <link rel="stylesheet" href="custom-scrollbars.css">
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #2B2D30; /* Dark background */
            color: #d0d0e0; /* Light muted text */
        }

        .container {
            background-color: #2B2D30;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
        }

        /* Start fixed datagrid header*/

        /* Update these styles in your CSS section */
        .table-container {
            position: relative;
            height: 600px; /* Set a fixed height or use calc() */
            overflow-y: auto; /* Changed from 'hidden' to 'auto' to enable scrolling */
            margin-bottom: 20px;
        }

        /* Optional: If you want to use viewport height instead */
        .table-container {
            height: calc(100vh - 250px); /* Adjust the subtracted value based on your header and other elements */
        }

            /* Ensure the table takes full width */
            .table-container table {
                width: 100%;
            }

        /* Fix for header appearance */
        table.dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #3b3f51;
        }

        /* Fix DataTables scrolling */
        .dataTables_scrollBody {
            max-height: none !important;
        }

        /* End fixed datagrid header*/
        h1 {
            color: #ffffff; /* Soft blue header text */
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

            .filter-controls label {
                font-weight: bold;
                color: #c8d1e1;
            }

            .filter-controls select,
            .filter-controls input[type="text"] {
                padding: 8px;
                border: 1px solid #3a3f54;
                border-radius: 4px;
                background-color: #3a3f54;
                color: #ffffff;
            }

            .filter-controls button {
                padding: 8px 15px;
                background-color: #3498db; /* Bright blue button */
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.3s ease;
            }

                .filter-controls button:hover {
                    background-color: #0078D7;
                }

        table.dataTable {
            background-color: #2a2d3e;
            border-collapse: collapse;
        }

            table.dataTable thead {
                background-color: #3b3f51;
                color: #ffffff;
            }

            table.dataTable th,
            table.dataTable td {
                border: 1px solid #444857;
                padding: 10px;
                color: #dcdcdc;
            }

            table.dataTable tbody tr:hover {
                background-color: #363a4a;
            }

        .dataTables_info,
        .dataTables_paginate {
            color: #c0c0c0;
        }

        .dataTables_wrapper .dataTables_filter input {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        .dataTables_wrapper .dataTables_length select {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        /* Scroll bar and search box fixes*/
        /* Center the search box */
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Style scrollbar for webkit browsers (Chrome, Safari, Edge) */
        .table-container::-webkit-scrollbar {
            width: 25px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #2a2d3e;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
            border: 2px solid #2a2d3e;
        }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #0078D7;
            }

        /* Style scrollbar for Firefox */
        .table-container {
            scrollbar-width: auto;
            scrollbar-color: #3498db #2a2d3e;
        }

        /* Add some spacing to the DataTables controls */
        .dataTables_wrapper .dataTables_length {
            margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 10px;
            width: 250px; /* Make search box wider */
        }

        /* Optional: Add a subtle transition effect to the scrollbar thumb */
        .table-container::-webkit-scrollbar-thumb {
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">

        <h1><i class="bi bi-card-list"></i> Printcard Inventory</h1>

        <!--<h1> Printcard Inventory</h1>-->

        <div class="filter-controls">
            <label for="yearSelect">Year:</label>
            <select id="yearSelect"></select>

            <label for="monthSelect">Month:</label>
            <select id="monthSelect">
                <option value="">All Months</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>

            <button id="loadDataButton">Load Data</button>
            <button id="viewPrintcardButton" disabled>View Printcard</button>
            <button id="exportPrintcardItems" disabled>Download as Excel</button>
        </div>
        <div class="table-container">
            <div class="table-responsive">
                <table id="printcardTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Organization Name</th>
                            <th>Box Description</th>
                            <th>Printcard No.</th>
                            <th>Board Size</th>
                            <th>Inside Dimension</th>
                            <th>Filename</th>
                            <th>Status</th>
                            <th>File Type</th>
                            <th>Date Created</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>        
    </div>
    
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

    <script>
        let printcardDataTable;
        let currentYearFilter = new Date().getFullYear().toString(); // Default to current year
        let currentMonthFilter = ''; // Default to all months
        let selectedPrintcardId = null; // Variable to store

        // Populate year dropdown
        function populateYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 25; i--) { // Last 10 years
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear; // Set default selection
        }

        // Initialize DataTables with server-side processing
        function initializeDataTable() {
            if (printcardDataTable) {
                // If table already exists, destroy it before re-initializing
                printcardDataTable.destroy();
                $('#printcardTable tbody').empty(); // Clear existing rows
            }

            printcardDataTable = $('#printcardTable').DataTable({
                processing: true, // Show processing indicator
                serverSide: true, // Enable server-side processing
                ajax: async function (data, callback, settings) {
                    // `data` object contains DataTables parameters like draw, start, length, search.value
                    console.log('DataTables AJAX request data:', data);

                    const draw = data.draw;
                    const start = data.start;
                    const length = data.length;
                    const searchValue = data.search.value; // Global search value

                    // We use the currently selected year/month filters for the initial load
                    // or when a search term is NOT provided.
                    // If a search term IS provided, we want to search ALL data regardless of date.
                    // The C# method will handle this by conditionally applying the date filter.
                    const yearToPass = currentYearFilter;
                    const monthToPass = currentMonthFilter;

                    try {
                        const jsonData = await chrome.webview.hostObjects.printcardApi.GetPrintcardsForDataTable(
                            draw,
                            start,
                            length,
                            searchValue,
                            yearToPass,
                            monthToPass
                        );

                        const response = JSON.parse(jsonData);

                        if (response.error) {
                            console.error("Error from C#:", response.error);
                            alert("Error loading data: " + response.error);
                            callback({ // Return an empty dataset on error
                                draw: draw,
                                recordsTotal: 0,
                                recordsFiltered: 0,
                                data: []
                            });
                            return;
                        }

                        console.log('Received data from C#:', response);

                        callback({
                            draw: response.draw,
                            recordsTotal: response.recordsTotal,
                            recordsFiltered: response.recordsFiltered,
                            data: response.data
                        });

                    } catch (e) {
                        console.error("Error calling C# or parsing JSON:", e);
                        alert("An unexpected error occurred: " + e.message);
                        callback({ // Return an empty dataset on error
                            draw: draw,
                            recordsTotal: 0,
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                },
                columns: [
                    { data: 'printcardId' },
                    { data: 'organizationName' },
                    { data: 'boxDescription' },
                    { data: 'printcardNo' },
                    { data: 'boardSize' },                    
                    { data: 'insideDimension' },
                    { data: 'filename' },
                    { data: 'status' },                    
                    { data: 'fileType' },
                    {
                        data: 'dateCreated',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return new Date(data).toLocaleDateString();
                            }
                            return data;
                        }
                    }
                ],
                scrollY: '100%',        // Changed from true to '100%'
                scrollCollapse: true,
                paging: true,
                lengthMenu: [10, 25, 50, 100],
                pageLength: 10, // Initial page size
                searching: true, // Enable search box
                ordering: true, // Enable column ordering (DataTables will send order params to server)
                info: true, // Show "Showing X of Y entries" info
                responsive: true, // Make table responsive
                select: {
                    style: 'single',  // Allow only single row selection
                    info: false       // Don't show selected item info
                },
                // Add CSS class for selected row
                rowCallback: function (row, data, index) {
                    $(row).attr('data-printcard-id', data.printcardId);
                }
                // You might also want to implement server-side ordering (via 'order' parameter in data.order)
                // This would involve modifying your C# query to include ORDER BY based on DataTables' request.
            });
            // Handle row selection
            $('#printcardTable tbody').on('click', 'tr', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                    selectedPrintcardId = null;
                    $('#viewPrintcardButton').prop('disabled', true);
                } else {
                    printcardDataTable.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                    selectedPrintcardId = $(this).data('printcard-id');
                    $('#viewPrintcardButton').prop('disabled', false);
                }
            });            
            // Handle View Printcard button click
            $('#viewPrintcardButton').on('click', async function () {
                if (selectedPrintcardId) {
                    try {
                        // Get the selected row's data
                        const selectedRow = printcardDataTable.row('.selected').data();

                        // Call the C# DownloadViewFile method with the required parameters
                        await chrome.webview.hostObjects.printcardApi.DownloadViewFile(
                            selectedPrintcardId,      // id parameter
                            selectedRow.filename,      // sFileName parameter
                            selectedRow.fileType      // sFileExtension parameter
                        );
                    } catch (e) {
                        console.error("Error viewing printcard:", e);
                        console.log('Selected Printcard ID:', selectedPrintcardId);
                        alert("Error viewing printcard: " + e.message);
                    }
                }
            });          

            $('#exportPrintcardItems').on('click', async function () {
                try {
                    const yearToPass = document.getElementById('yearSelect').value;
                    const monthToPass = document.getElementById('monthSelect').value;

                    const filePath = await chrome.webview.hostObjects.printcardApi.ExportPrintcardsToExcel(
                        yearToPass,
                        monthToPass
                    );
                    if (filePath && typeof filePath === 'string' && filePath.trim() !== '') {
                        await chrome.webview.hostObjects.printcardApi.OpenExportedFile(filePath);
                    } else {
                        // This case handles if ExportPrintcardsToExcel somehow returns an invalid path
                        throw new Error("Export operation did not return a valid file path.");
                    }
                } catch (e) {
                    console.error("Error exporting to Excel:", e);                    
                    alert("Error exporting to Excel: " + e.message + "\nPlease check console for more details.");
                }
            });


            // Enable export button when data is loaded
            printcardDataTable.on('draw', function () {
                $('#exportPrintcardItems').prop('disabled', false);
            });
            
        }

        // Event listener for the "Load Data" button
        document.getElementById('loadDataButton').addEventListener('click', function () {
            currentYearFilter = document.getElementById('yearSelect').value;
            currentMonthFilter = document.getElementById('monthSelect').value;
            printcardDataTable.ajax.reload(null, true); // Reload DataTables, resetting pagination
        });

        $(document).ready(function () {
            populateYearSelect();
            initializeDataTable(); // Initial load of the table
        });
        document.getElementById('viewPrintcardButton').addEventListener('click', function () {
            // Store the original text and disabled state
            const button = this;
            const originalText = button.textContent;
            const wasDisabled = button.disabled;

            // Simulate busy state
            button.disabled = true;
            button.textContent = 'Processing...';
            button.style.opacity = '0.5'; // Optional: Make it look faded

            // Revert after 3 seconds (3000 milliseconds)
            setTimeout(function () {
                button.textContent = originalText;
                button.disabled = wasDisabled; // Restore original disabled state
                button.style.opacity = ''; // Reset opacity
            }, 3000);
        });

    </script>
</body>
</html>