<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Scheduled Items</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!--<link href="./bootstrap-icons/bootstrap.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="./bootstrap-icons/bootstrap-icons.min.css">
    <link rel="stylesheet" href="custom-scrollbars.css">

    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #2B2D30; /* Dark background */
            color: #d0d0e0; /* Light muted text */
        }

        .container {
            background-color: #2B2D30;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
        }

        /* Start fixed datagrid header*/

        /* Update these styles in your CSS section */
        .table-container {
            position: relative;
            height: 600px; /* Set a fixed height or use calc() */
            overflow-y: auto; /* Changed from 'hidden' to 'auto' to enable scrolling */
            margin-bottom: 20px;
        }

        /* Optional: If you want to use viewport height instead */
        .table-container {
            height: calc(100vh - 250px); /* Adjust the subtracted value based on your header and other elements */
        }

            /* Ensure the table takes full width */
            .table-container table {
                width: 100%;
            }

        /* Fix for header appearance */
        table.dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #3b3f51;
        }

        /* Fix DataTables scrolling */
        .dataTables_scrollBody {
            max-height: none !important;
        }

        /* End fixed datagrid header*/
        h1 {
            color: #ffffff; /* Soft blue header text */
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

            .filter-controls label {
                font-weight: bold;
                color: #c8d1e1;
            }

            .filter-controls select,
            .filter-controls input[type="text"] {
                padding: 8px;
                border: 1px solid #3a3f54;
                border-radius: 4px;
                background-color: #3a3f54;
                color: #ffffff;
            }

            .filter-controls button {
                padding: 8px 15px;
                background-color: #3498db; /* Bright blue button */
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.3s ease;
            }

                .filter-controls button:hover {
                    background-color: #0078D7;
                }

        table.dataTable {
            background-color: #2a2d3e;
            border-collapse: collapse;
        }

            table.dataTable thead {
                background-color: #3b3f51;
                color: #ffffff;
            }

            table.dataTable th,
            table.dataTable td {
                border: 1px solid #444857;
                padding: 10px;
                color: #dcdcdc;
            }

            table.dataTable tbody tr:hover {
                background-color: #363a4a;
            }

        .dataTables_info,
        .dataTables_paginate {
            color: #c0c0c0;
        }

        .dataTables_wrapper .dataTables_filter input {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        .dataTables_wrapper .dataTables_length select {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        /* Scroll bar and search box fixes*/
        /* Center the search box */
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Style scrollbar for webkit browsers (Chrome, Safari, Edge) */
        .table-container::-webkit-scrollbar {
            width: 25px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #2a2d3e;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
            border: 2px solid #2a2d3e;
        }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #0078D7;
            }

        /* Style scrollbar for Firefox */
        .table-container {
            scrollbar-width: auto;
            scrollbar-color: #3498db #2a2d3e;
        }

        /* Add some spacing to the DataTables controls */
        .dataTables_wrapper .dataTables_length {
            margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 10px;
            width: 250px; /* Make search box wider */
        }

        /* Optional: Add a subtle transition effect to the scrollbar thumb */
        .table-container::-webkit-scrollbar-thumb {
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!--<h1>Machine Scheduled Items</h1>-->
        <h1><i class="bi bi-gear-wide-connected"></i> Machine Scheduled Items </h1>
        <h4><br />Converting Printer Machines only</h4>
        <div class="filter-controls">
            <button id="loadDataButton">Load Data</button>
        </div>

        <div class="table-container">
            <table id="machineSchedTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Job #</th>
                        <th>Description</th>
                        <th>Printcard No.</th>
                        <th>Machine</th>
                        <th>Machine Code</th>
                        <th>Production Quantity</th>
                        <th>Ordered Quantity</th>
                        <th>Board Size</th>
                        <th>Date Created</th>
                        <th>User</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

    <script>
        let MacScheduleDataTable;
        // Initialize DataTables with server-side processing
        function initializeDataTable() {
            if (MacScheduleDataTable) {
                // If table already exists, destroy it before re-initializing
                MacScheduleDataTable.destroy();
                $('#machineSchedTable tbody').empty(); // Clear existing rows
            }

            MacScheduleDataTable = $('#machineSchedTable').DataTable({
                processing: true, // Show processing indicator
                serverSide: true, // Enable server-side processing
                ajax: async function (data, callback, settings) {
                    // `data` object contains DataTables parameters like draw, start, length, search.value
                    console.log('DataTables AJAX request data:', data);

                    const draw = data.draw;
                    const start = data.start;
                    const length = data.length;
                    const searchValue = data.search.value; // Global search value

                    try {
                        const jsonData = await chrome.webview.hostObjects.machineApi.GetMachineScheduleDataTable(
                            draw,
                            start,
                            length,
                            searchValue
                        );

                        const response = JSON.parse(jsonData);

                        if (response.error) {
                            console.error("Error from C#:", response.error);
                            alert("Error loading data: " + response.error);
                            callback({ // Return an empty dataset on error
                                draw: draw,
                                recordsTotal: 0,     
                                recordsFiltered: 0,
                                data: []
                            });
                            return;
                        }

                        console.log('Received data from C#:', response);

                        callback({
                            draw: response.draw,
                            recordsTotal: response.recordsTotal,    
                            recordsFiltered: response.recordsFiltered,
                            data: response.data
                        });

                    } catch (e) {
                        console.error("Error calling C# or parsing JSON:", e);
                        console.log('Raw response data:', JSON.stringify(response.data, null, 2));
                        alert("An unexpected error occurred: " + e.message);
                        callback({ // Return an empty dataset on error
                            draw: draw,
                            recordsTotal: 0,               
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                }, //Cu_Na, Pdl_Order, Ordsb_Boxname, Pdl_Boxno, Mch_Name, Pdl_Mchno, Pdl_Trgqty, Ordsb_Qty, Ordsb_Ordsize, Pdl_Date, pdl_Adduser
                columns: [
                    { data: 'cu_Na' },
                    { data: 'pdl_Order' },
                    { data: 'ordsb_Boxname' },
                    { data: 'pdl_Boxno' },
                    { data: 'mch_Name' },
                    { data: 'pdl_Mchno' },
                    { data: 'pdl_Trgqty' },
                    { data: 'ordsb_Qty' },
                    { data: 'ordsb_Ordsize' },    
                    { data: 'pdl_Date' },                       
                    { data: 'pdl_Adduser' }
                ],
                scrollY: '100%',        // Enable vertical scrolling
                scrollCollapse: true, // Enable scroll collapse
                paging: true,
                lengthMenu: [10, 25, 50, 100],
                pageLength: 10, // Initial page size
                searching: true, // Enable search box
                ordering: true, // Enable column ordering (DataTables will send order params to server)
                info: true, // Show "Showing X of Y entries" info
                responsive: true // Make table responsive
                // You might also want to implement server-side ordering (via 'order' parameter in data.order)
                // This would involve modifying your C# query to include ORDER BY based on DataTables' request.        
            });
        }

        // Event listener for the "Load Data" button
        document.getElementById('loadDataButton').addEventListener('click', function () {
            MacScheduleDataTable.ajax.reload(null, true); // Reload DataTables, resetting pagination
        });

        $(document).ready(function () {            
            initializeDataTable(); // Initial load of the table
        });
    </script>
</body>
</html>