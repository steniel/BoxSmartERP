<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diecut Inventory</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="./bootstrap-icons/bootstrap-icons.min.css">
    <link rel="stylesheet" href="custom-scrollbars.css">
    <link rel="stylesheet" href="css/NewRequest.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #2B2D30;
            color: #d0d0e0; 
        }

        .container {
            background-color: #2B2D30;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
        }


        .table-container {
            position: relative;
            height: 600px; 
            overflow-y: auto; 
            margin-bottom: 20px;
        }

        .table-container {
            height: calc(100vh - 250px);
        }

            .table-container table {
                width: 100%;
            }

        table.dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #3b3f51;
        }

        .dataTables_scrollBody {
            max-height: none !important;
        }

        h1 {
            color: #ffffff; 
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

            .filter-controls label {
                font-weight: bold;
                color: #c8d1e1;
            }

            .filter-controls select,
            .filter-controls input[type="text"] {
                padding: 8px;
                border: 1px solid #3a3f54;
                border-radius: 4px;
                background-color: #3a3f54;
                color: #ffffff;
            }

            .filter-controls button {
                padding: 8px 15px;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.3s ease;
            }

                .filter-controls button:hover {
                    background-color: #0078D7;
                }

        table.dataTable {
            background-color: #2a2d3e;
            border-collapse: collapse;
        }

            table.dataTable thead {
                background-color: #3b3f51;
                color: #ffffff;
            }

            table.dataTable th,
            table.dataTable td {
                border: 1px solid #444857;
                padding: 10px;
                color: #dcdcdc;
            }

            table.dataTable tbody tr:hover {
                background-color: #363a4a;
            }

        .dataTables_info,
        .dataTables_paginate {
            color: #c0c0c0;
        }

        .dataTables_wrapper .dataTables_filter input {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        .dataTables_wrapper .dataTables_length select {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: center;
            margin-bottom: 20px;
        }

        .table-container::-webkit-scrollbar {
            width: 25px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #2a2d3e;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
            border: 2px solid #2a2d3e;
        }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #0078D7;
            }

        .table-container {
            scrollbar-width: auto;
            scrollbar-color: #3498db #2a2d3e;
        }

        .dataTables_wrapper .dataTables_length {
            margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 10px;
            width: 250px;
        }

        .table-container::-webkit-scrollbar-thumb {
            transition: background-color 0.3s ease;
        }

        .modal {
            display: none; 
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); 
        }

        .modal-content {
            background-color: #222;
            color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 700px;
            max-width: 95%;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 0 0 4px #444 inset;
            border: 1px solid #444;
        }

        .modal-header {
            background-color: #1a1a1a;
            padding: 18px 24px;
            border-bottom: 2px solid #444;
            border-top: 4px solid #00bcd4; /* Cyan accent */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

            .modal-header .close {
                font-size: 1.5rem;
                color: #ccc;
                cursor: pointer;
                transition: color 0.2s ease;
            }

                .modal-header .close:hover {
                    color: #fff;
                }

        .modal-body {
            padding: 20px 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 24px;
        }

        /* Form Group */
        .form-group {
            display: flex;
            flex-direction: column;
        }

            .form-group label {
                margin-bottom: 6px;
                font-size: 0.95rem;
                color: #bbb;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px 10px;
                font-size: 0.95rem;
                border: 1px solid #555;
                background-color: #2c2c2c;
                color: #fff;
                border-radius: 4px;
                width: 100%;
            }

            .form-group textarea {
                resize: vertical;
                min-height: 60px;
            }

        /* Make Notes span full width */
        #notes {
            grid-column: span 2;
        }

        /* Footer */
        .modal-footer {
            padding: 16px 24px;
            text-align: right;
            border-top: 1px solid #444;
            background-color: #1b1b1b;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

            .modal-footer .btn-primary {
                background-color: #00bcd4;
                color: #fff;
                border: none;
                padding: 10px 18px;
                font-weight: 600;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

                .modal-footer .btn-primary:hover {
                    background-color: #0078D7;
                }

        /* 0078D7 #00acc1*/
        #debugOutput {
            margin-top: 20px;
            padding: 10px;
            background-color: #333;
            border: 1px solid #444;
            color: #ffffff;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Default text color for list items */
        #diecutSearchResults .list-group-item {
            color: #e0e0e0; /* A light grey or off-white for better visibility in dark mode */
            background-color: #2c2c2c; /* Ensure the background matches the modal's input background or is slightly different */
            border-color: #444; /* Adjust border color to match other elements or for subtle separation */
        }

            /* Hover/Focus state for list items */
            #diecutSearchResults .list-group-item:hover,
            #diecutSearchResults .list-group-item:focus {
                color: #ffffff; /* Brighter white on hover */
                background-color: #3b3f51; /* A darker, yet distinct background on hover (similar to table header) */
                text-decoration: none; /* Remove underline on hover if present */
            }

            /* If you also want to style the "No diecuts found" message */
            #diecutSearchResults .list-group-item.text-muted {
                color: #999999; /* A slightly darker grey for muted text */
                background-color: #2c2c2c; /* Consistent background */
                cursor: default; /* No pointer cursor for non-interactive items */
            }
    </style>

</head>
<body>
    <div class="container">

        <h1><i class="fa-solid fa-wrench"></i> Diecut Maintenance Log</h1>
        <p>All maintenance records for Diecut Tools</p>
        <!--<h1> Diecut Inventory</h1>-->

        <div class="filter-controls">
            <label for="yearSelect">Year:</label>
            <select id="yearSelect"></select>

            <label for="monthSelect">Month:</label>
            <select id="monthSelect">
                <option value="">All Months</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>

            <button id="loadDataButton">Load Data</button>            
            <button class="btn btn-primary" id="addMaintenanceBtn">Add Maintenance</button>

        </div>
        <div class="table-container">
            <div class="table-responsive">
                <table id="diecutTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Diecut ID</th>
                            <th>Customer</th>
                            <th>Description</th>
                            <th>Diecut #</th>
                            <th>Type</th>
                            <th>Assigned Mac</th>
                            <th>Action</th>
                            <th>Downtime(Hrs)</th>
                            <th>Current Usage</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Date Created</th>
                        </tr>
                    </thead>
                    <tbody id="maintenanceTableBody">
                    </tbody>
                </table>
                <div id="debugOutput"></div>
            </div>
        </div>

        <!-- Modal for Add/Edit -->
        <div id="maintenanceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="modalTitle">Add Maintenance Record</h4>
                    <!--<button class="btn btn-close" onclick="closeModal()">Close</button>-->
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <label for="diecutSearch" class="form-label">Diecut Search <span class="required">*</span></label>
                        <input type="text" id="diecutSearch" class="form-control" placeholder="Search by diecut name..." required>
                        <input type="hidden" id="SelectedDiecutId" name="diecutId">
                        <div id="diecutSearchResults" class="list-group"></div>
                        <small id="selectedDiecutDisplay" class="form-text text-muted" style="display: none; margin-top: 5px;">Selected diecut: <strong id="diecutNameValue"></strong></small>
                    </div>

                    <div class="form-group">
                        <label for="maintenanceDate">Maintenance Date</label>
                        <input type="datetime-local" id="maintenanceDate" name="maintenanceDate" required>
                    </div>

                    <div class="form-group">
                        <label for="maintenanceAction">Maintenance Type/Action</label>
                        <select id="maintenanceAction" required>
                            <option value="1">Repair</option>
                            <option value="2">Overhaul</option>
                            <option value="3">Cleaning</option>
                            <option value="4">Inspection</option>
                            <option value="5">Lubrication</option>
                            <option value="6">Component Replacement</option>
                            <option value="7">Reassembly</option>
                            <option value="8">Troubleshooting</option>
                        </select>
                    </div>

                    <!--<div class="form-group">
                        <label for="userId">User ID</label>
                        <input type="number" id="userId" name="userId" required>
                    </div>-->

                    <div style="flex: 1;">
                        <label for="userSearch" class="form-label">Assign to: <span class="required">*</span></label>
                        <input type="text" id="userSearch" class="form-control" placeholder="Search by username..." required>
                        <input type="hidden" id="selectedUserId" name="userId">                        
                        <div id="userSearchResults" class="list-group"></div>
                        <small id="selectedUserDisplay" class="form-text text-muted" style="display: none; margin-top: 5px;">Personnel selected: <strong id="userNameValue"></strong></small>
                    </div>

                    <div class="form-group">
                        <label for="estimatedDowntime">Estimated Downtime (hrs)</label>
                        <!--<input type="number" id="estimatedDowntime" name="estimatedDowntime" step="1" min="1">-->
                        <input type="number" id="estimatedDowntime" value="10" name="estimatedDowntime">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" maxlength="250"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <!--<button class="btn btn-primary" onclick="saveMaintenance()">Save</button>-->
                    <button type="submit" class="btn btn-primary" id="submitMaintenance">
                        <i class="bi bi-send-fill"></i> Submit Maintenance
                    </button>
                </div>
            </div>
        </div>

    </div>    

    <script>                

        let diecutDataTable;
        let currentYearFilter = new Date().getFullYear().toString(); // Default to current year
        let currentMonthFilter = ''; // Default to all months
        let SelectedDiecutId = null; // Variable to store

        // Populate year dropdown
        function populateYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 25; i--) { // Last 10 years
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear; // Set default selection
        }

        // Initialize DataTables with server-side processing
        function initializeDataTable() {
            if (diecutDataTable) {
                // If table already exists, destroy it before re-initializing
                diecutDataTable.destroy();
                $('#diecutTable tbody').empty(); // Clear existing rows
            }

            console.log("InitializingDataTable() function executed...");

            diecutDataTable = $('#diecutTable').DataTable({
                processing: true, // Show processing indicator
                serverSide: true, // Enable server-side processing
                ajax: async function (data, callback, settings) {
                    // `data` object contains DataTables parameters like draw, start, length, search.value
                    console.log('DataTables AJAX request data:', data);
                    console.log("diecutTable() datatable executed...");
                    const draw = data.draw;
                    const start = data.start;
                    const length = data.length;
                    const searchValue = data.search.value; // Global search value

                    const yearToPass = currentYearFilter;
                    const monthToPass = currentMonthFilter;

                    try {
                        const jsonData = await chrome.webview.hostObjects.printcardApi.GetDiecutMaintenanceTable(
                            draw,
                            start,
                            length,
                            searchValue,
                            yearToPass,
                            monthToPass
                        );

                        const response = JSON.parse(jsonData);
                        console.log('First row of data:', response.data[0]);

                        if (response.error) {
                            console.error("Error from C#:", response.error);
                            alert("Error loading data: " + response.error);
                            callback({ // Return an empty dataset on error
                                draw: data.draw,
                                recordsTotal: 0,
                                recordsFiltered: 0,
                                data: []
                            });
                            return;
                        }

                        console.log('Received data from C#:', response);

                        callback({
                            draw: data.draw,
                            recordsTotal: response.recordsTotal,
                            recordsFiltered: response.recordsFiltered,
                            data: response.data
                        });

                    } catch (e) {
                        console.error("Error calling C# or parsing JSON:", e);
                        alert("An unexpected error occurred: " + e.message);
                        callback({ // Return an empty dataset on error
                            draw: draw,
                            recordsTotal: 0,
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                },
                columns: [
                    { data: 'maintenanceId', "visible": false },
                    { data: 'organizationName' },
                    { data: 'itemDescription' },
                    { data: 'diecutNumber' },
                    { data: 'diecutType' },
                    { data: 'assignedMachine' },
                    { data: 'maintenanceAction'},
                    { data: 'estimatedDownTime'},
                    { data: 'currentUsage' },
                    { data: 'itemNotes' },
                    { data: 'itemStatus' },
                    {
                        data: 'dateCreated',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return new Date(data).toLocaleDateString();
                            }
                            return data;
                        }
                    }
                ],
                scrollY: '100%',        // Changed from true to '100%'
                scrollCollapse: true,
                paging: true,
                lengthMenu: [10, 25, 50, 100],
                pageLength: 10, // Initial page size
                searching: true, // Enable search box
                ordering: true, // Enable column ordering (DataTables will send order params to server)
                info: true, // Show "Showing X of Y entries" info
                responsive: true, // Make table responsive
                select: {
                    style: 'single',  // Allow only single row selection
                    info: false       // Don't show selected item info
                },
                // Add CSS class for selected row
                rowCallback: function (row, data, index) {
                    $(row).attr('data-diecut-id', data.diecutId);
                }
                // You might also want to implement server-side ordering (via 'order' parameter in data.order)
                // This would involve modifying your C# query to include ORDER BY based on DataTables' request.
            });


        }

        // Event listener for the "Load Data" button
        document.getElementById('loadDataButton').addEventListener('click', function () {
            currentYearFilter = document.getElementById('yearSelect').value;
            currentMonthFilter = document.getElementById('monthSelect').value;
            diecutDataTable.ajax.reload(null, true); // Reload DataTables, resetting pagination
        });

        $(document).ready(function () {
            populateYearSelect();
            initializeDataTable(); // Initial load of the table
        });

        /*
        *********************************************************************
        ******************* MAINTENANCE LOG FUNCTIONS ***********************
        *********************************************************************
        */
        document.addEventListener('DOMContentLoaded', function () {
            const addButton = document.getElementById('addMaintenanceBtn');
            if (addButton) { 
                addButton.addEventListener('click', openAddModal);
            }

            /* User Search */
            const userSearchInput = document.getElementById('userSearch');
            const userSearchResultsDiv = document.getElementById('userSearchResults');
            const selectedUserIdField = document.getElementById('selectedUserId');
            const selectedUserDisplay = document.getElementById('selectedUserDisplay');
            let userSearchTimeout;

            userSearchInput.addEventListener('keyup', function () {
                clearTimeout(userSearchTimeout);
                const query = this.value.trim();
                const selectedUserId = selectedUserIdField.value;

                if (query.length >= 2) {
                    userSearchTimeout = setTimeout(() => {
                        performUserSearch(query, selectedUserId);
                    }, 300);
                } else {
                    userSearchResultsDiv.style.display = 'none';
                    userSearchResultsDiv.innerHTML = '';
                    selectedUserIdField.value = '';
                    selectedUserDisplay.style.display = 'none';
                    userSearchInput.classList.remove('is-valid');
                    userSearchInput.classList.remove('is-invalid');
                }
            });

            async function performUserSearch(query) {
                if (!chrome.webview.hostObjects.requestsApi) {
                    console.error("requestsApi not available. Cannot perform user search.");
                    userSearchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error: requestsApi not found.</div>';
                    userSearchResultsDiv.style.display = 'block';
                    return;
                }

                try {
                    const userJsonString = await chrome.webview.hostObjects.printcardApi.SearchUsers(query);
                    const parsedUsers = JSON.parse(userJsonString);
                    displayUserResults(parsedUsers);
                } catch (error) {
                    console.error("Error searching users:", error);
                    userSearchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error searching users.</div>';
                    userSearchResultsDiv.style.display = 'block';
                }
            }

            function displayUserResults(users) {
                userSearchResultsDiv.innerHTML = '';
                if (users && users.length > 0) {
                    users.forEach(users => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.classList.add('list-group-item', 'list-group-item-action');
                        item.textContent = users.fullname;
                        item.dataset.id = users.id;

                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            selectUser(this.dataset.id, this.textContent);
                        });
                        userSearchResultsDiv.appendChild(item);
                    });
                    userSearchResultsDiv.style.display = 'block';
                } else {
                    const noResultsItem = document.createElement('div');
                    noResultsItem.classList.add('list-group-item', 'text-muted');
                    noResultsItem.textContent = 'No users found.';
                    userSearchResultsDiv.appendChild(noResultsItem);
                    userSearchResultsDiv.style.display = 'block';
                }
            }

            function selectUser(id, name) {
                selectedUserIdField.value = id;
                userSearchInput.value = name;
                userSearchResultsDiv.style.display = 'none';
                userSearchResultsDiv.innerHTML = '';

                userNameValue.textContent = name;
                selectedUserDisplay.style.display = 'block';

                userSearchInput.classList.add('is-valid');
                userSearchInput.classList.remove('is-invalid');
            }

            /* Diecut Search Input*/
            const diecutSearchInput = document.getElementById('diecutSearch');
            const diecutSearchResultsDiv = document.getElementById('diecutSearchResults');
            const selectedDiecutIdField = document.getElementById('SelectedDiecutId');
            const selectedDiecutDisplay = document.getElementById('selectedDiecutDisplay');
            const diecutNameValue = document.getElementById('diecutNameValue');

            let diecutSearchTimeout;

            diecutSearchInput.addEventListener('keyup', function () {
                clearTimeout(diecutSearchTimeout);
                const query = this.value.trim();

                if (query.length >= 3) {
                    diecutSearchTimeout = setTimeout(() => {
                        performDiecutSearch(query);
                    }, 300);
                } else {
                    diecutSearchResultsDiv.style.display = 'none';
                    diecutSearchResultsDiv.innerHTML = '';
                    selectedDiecutIdField.value = '';
                    selectedDiecutDisplay.style.display = 'none';
                    diecutSearchInput.classList.remove('is-valid');
                    diecutSearchInput.classList.remove('is-invalid');
                }
            });

            async function performDiecutSearch(query) {
                if (!chrome.webview.hostObjects.printcardApi) {
                    console.error("printcardApi not available. Cannot perform diecut search.");
                    diecutSearchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error: printcardApi not found.</div>';
                    diecutSearchResultsDiv.style.display = 'block';
                    return;
                }

                try {
                    const diecutsJsonString = await chrome.webview.hostObjects.printcardApi.SearchDiecuts(query);
                    const parseddiecuts = JSON.parse(diecutsJsonString);
                    displayDiecutResults(parseddiecuts);
                } catch (error) {
                    console.error("Error searching diecuts:", error);
                    diecutSearchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error searching diecuts.</div>';
                    diecutSearchResultsDiv.style.display = 'block';
                }
            }

            function displayDiecutResults(diecuts) {
                diecutSearchResultsDiv.innerHTML = '';
                if (diecuts && diecuts.length > 0) {
                    diecuts.forEach(diecut => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.classList.add('list-group-item', 'list-group-item-action');
                        item.textContent = diecut.item_description;
                        item.dataset.id = diecut.id;

                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            selectDiecut(this.dataset.id, this.textContent);
                        });
                        diecutSearchResultsDiv.appendChild(item);
                    });
                    diecutSearchResultsDiv.style.display = 'block';
                } else {
                    diecutSearchResultsDiv.innerHTML = '<div class="list-group-item text-muted">No diecuts found.</div>';
                    diecutSearchResultsDiv.style.display = 'block';
                }
            }

            function selectDiecut(id, name) {
                selectedDiecutIdField.value = id;
                diecutSearchInput.value = name;
                diecutSearchResultsDiv.style.display = 'none';
                diecutSearchResultsDiv.innerHTML = '';

                diecutNameValue.textContent = name;
                selectedDiecutDisplay.style.display = 'block';

                diecutSearchInput.classList.add('is-valid');
                diecutSearchInput.classList.remove('is-invalid');
            }

            document.querySelectorAll('[required]').forEach(field => {
                field.addEventListener('input', function () {
                    if (this.value.trim()) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        this.classList.remove('is-valid');
                    }
                });
                field.addEventListener('blur', function () {
                    if (!this.value.trim()) {
                        this.classList.add('is-invalid');
                    }
                });
            });

            const submitMaintenanceBtn = document.getElementById("submitMaintenance");
            submitMaintenanceBtn.addEventListener('click', function (e) {
                e.preventDefault();
                /* Variables */
                let errorMsg = "";
                let isValidModalWindow = true;
                const maintenanceDateInput = document.getElementById('maintenanceDate');
                let diecutInput = document.getElementById("SelectedDiecutId");
                let diecutValue = diecutInput.value.trim();
                let estDowntimeInput = document.getElementById("estimatedDowntime");
                let downtimeValue = estDowntimeInput.value.trim();
                let selectedUserInput = document.getElementById("selectedUserId");
                let selectedUserValue = selectedUserInput.value.trim();

                if (diecutValue === "" || isNaN(Number(diecutValue))) {
                    console.log("SelectedDiecutId is empty or not a valid number.");
                    diecutInput.classList.add('is-invalid');
                    isValidModalWindow = false;
                    errorMsg += "Diecut";
                } else {
                    diecutInput.classList.remove('is-invalid');
                    console.log("SelectedDiecutId:", diecutValue);
                }
                if (selectedUserValue === "" || isNaN(Number(selectedUserValue))) {
                    console.log("Selected user is empty.");
                    selectedUserInput.classList.add('is-invalid');
                    isValidModalWindow = false;
                    if (!errorMsg.trim.value) {
                        errorMsg += ", " + "Assign to";
                    } else {
                        errorMsg = "Assign to";
                    }
                } else {
                    selectedUserInput.classList.remove('is-invalid');
                    console.log("Selected user:", selectedUserValue);
                }

                if (downtimeValue === "" || isNaN(Number(downtimeValue))) {
                    console.log("Estimated downtime is empty or not a valid number.");
                    estDowntimeInput.classList.add('is-invalid');
                    isValidModalWindow = false;
                    if (!errorMsg.trim.value) {
                        errorMsg += ", " + "Estimated downtime";
                    } else {
                        errorMsg = "Estimated downtime";
                    }
                } else {
                    estDowntimeInput.classList.remove('is-invalid');
                    console.log("Estimated downtime:", downtimeValue);
                }

                if (!maintenanceDateInput.value.trim()) {
                    maintenanceDateInput.classList.add('is-invalid');
                    isValidModalWindow = false;
                    if (!errorMsg.trim.value) {
                        errorMsg += ", " + "Maintenance date";
                    } else {
                        errorMsg = "Maintenance date";
                    }
                } else {
                    maintenanceDateInput.classList.remove('is-invalid');
                }

                //Saving
                if (!isValidModalWindow) {
                    toastr.error("Some field(s) are empty: " + errorMsg, null, { positionClass: "toast-top-center" });
                    return;
                } else {
                    if (!confirm("Are you sure you want to submit this request?")) {
                        return; // Cancel submission
                    }
                    //this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass"></i> Submitting...';    
                    const addMaintenanceData = collectData();
                    chrome.webview.hostObjects.printcardApi.InsertMaintenance(JSON.stringify(addMaintenanceData));
                    //saveMaintenance();                   

                    //Receive the message from C# backend
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.addEventListener('message', function (event) {
                            const receivedData = event.data;
                            console.log("Message received from C#:", receivedData);
                            try {
                                const parsedMessage = JSON.parse(receivedData);
                                console.log("Parsed message:", parsedMessage);

                                if (parsedMessage.action === "InsertMaintenanceSuccess") {
                                    toastr.info(parsedMessage.message);
                                    diecutDataTable.ajax.reload(null, true);
                                    setTimeout(() => {
                                        document.getElementById("SelectedDiecutId").value = "";
                                        document.getElementById('diecutSearch').value = "";
                                        document.getElementById("selectedUserDisplay").value = "";
                                        document.getElementById("userSearch").value = "";
                                        document.getElementById("estimatedDowntime").value = "";
                                        document.getElementById('maintenanceDate').value = "";
                                        document.getElementById('notes').value = "";
                                        this.disabled = false;
                                        this.innerHTML = '<i class="bi bi-send-fill"></i> Submit Maintenance';
                                        window.chrome.webview.postMessage("MaintenanceSuccess");
                                    }, 1500);
                                    closeModal();
                                } else {
                                    toastr.error("Failed to save maintenance.");
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-send-fill"></i> Submit Maintenance';
                                }
                            } catch (e) {
                                toastr.error("Error parsing message from C#:", e, receivedData);
                                console.error("Error parsing message from C#:", e, receivedData);     
                                this.disabled = false;
                                this.innerHTML = '<i class="bi bi-send-fill"></i> Submit Maintenance';
                            }
                        });
                        console.log("WebView2 message listener added.");
                    } else {
                        console.warn("window.chrome.webview is not available. Running outside WebView2?");
                    }                    
                }                                
            });

        });

        function collectData() {
            const mappedData = ({
                diecut_id: parseInt(document.getElementById('SelectedDiecutId').value),
                maintenance_date: document.getElementById('maintenanceDate').value,
                user_id: parseInt(document.getElementById('selectedUserId').value),
                estimated_downtime: parseFloat(document.getElementById('estimatedDowntime').value) || null,
                notes: document.getElementById('notes').value || null,
                action_id: parseInt(document.getElementById('maintenanceAction').value)      
            });
            return mappedData;
        }


        // Function to open the modal for adding a new record
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Maintenance Record';            
            document.getElementById('SelectedDiecutId').value = ''; 
            document.getElementById('maintenanceDate').value = '';
            document.getElementById('maintenanceAction').value = '1';
            document.getElementById('selectedUserId').value = '';            
            document.getElementById('estimatedDowntime').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('maintenanceModal').style.display = 'block';
        }

        // Function to open the modal for editing a record
        function editMaintenance(record) {
            document.getElementById('modalTitle').textContent = 'Edit Maintenance Record';
            document.getElementById('diecut_id').value = record.diecut_id;
            document.getElementById('maintenanceDate').value = new Date(record.maintenance_date).toISOString().slice(0, 16);
            document.getElementById('maintenanceAction').value = record.maintenanceActions;
            document.getElementById('selectedUserId').value = record.userId;
            document.getElementById('cost').value = record.cost || '';
            document.getElementById('estimatedDowntime').value = record.estimated_downtime || '';
            document.getElementById('notes').value = record.notes || '';
            document.getElementById('maintenanceModal').style.display = 'block';
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById('maintenanceModal').style.display = 'none';
        }
        // Function to save a maintenance record
        function saveMaintenance() {            
            const record = {
                diecut_id: parseInt(document.getElementById('SelectedDiecutId').value),
                maintenance_date: document.getElementById('maintenanceDate').value,                
                user_id: parseInt(document.getElementById('selectedUserId').value),              
                estimated_downtime: parseFloat(document.getElementById('estimatedDowntime').value) || null,
                notes: document.getElementById('notes').value || null,
                action_id: parseInt(document.getElementById('maintenanceAction').value)
            };
            try {
                window.chrome.webview.postMessage({
                    type: document.getElementById('modalTitle').textContent.includes('Add') ? 'addMaintenance' : 'editMaintenance',
                    record: record
                });
                logDebug(`Sent ${record.type} request: ${JSON.stringify(record)}`);                
            } catch (error) {
                logDebug(`Error sending save request: ${error.message}`);
            }
        }

        // Function to delete a maintenance record
        function deleteMaintenance(diecutId, maintenanceDate) {
            try {
                window.chrome.webview.postMessage({
                    type: 'deleteMaintenance',
                    diecut_id: diecutId,
                    maintenance_date: maintenanceDate
                });
                logDebug(`Sent delete request for diecut_id: ${diecutId}, maintenance_date: ${maintenanceDate}`);
            } catch (error) {
                logDebug(`Error sending delete request: ${error.message}`);
            }
        }

        // Initialize page
        try {
            populateYearDropdown();
            window.chrome.webview.postMessage({ type: 'fetchMaintenanceData', year: 2024 });
            logDebug('Requested initial maintenance data');
        } catch (error) {
            logDebug(`Error requesting initial data: ${error.message}`);
        }

        // Function to log debug messages
        function logDebug(message) {
            const debugDiv = document.getElementById('debugOutput');
            debugDiv.textContent += `\n${new Date().toISOString()}: ${message}`;
        }

        // Map maintenance types / actions
        const maintenanceActions = {
            1: 'Repair',
            2: 'Overhaul',
            3: 'Cleaning',
            4: 'Inspection',
            5: 'Lubrication',
            6: 'Component Replacement',
            7: 'Reassembly',
            8: 'Troubleshooting',            
        };

        // Populate year dropdown (2025 to 2010)
        function populateYearDropdown() {
            const select = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 2010; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.text = year;
                select.appendChild(option);
            }
            select.value = 2024; // Default to 2024
            logDebug(`Year dropdown populated, default year: ${select.value}`);
        }

        // Handle year selection change
        function onYearChange() {
            const year = document.getElementById('yearSelect').value;
            logDebug(`Year changed to: ${year}`);
            try {
                window.chrome.webview.postMessage({ type: 'fetchMaintenanceData', year: parseInt(year) });
            } catch (error) {
                logDebug(`Error sending message to C#: ${error.message}`);
            }
        }        

    </script>

</body>
</html>