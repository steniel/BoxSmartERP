<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diecut Inventory</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <link rel="stylesheet" href="./bootstrap-icons/bootstrap-icons.min.css">
    <link rel="stylesheet" href="custom-scrollbars.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #2B2D30; /* Dark background */
            color: #d0d0e0; /* Light muted text */
        }

        .container {
            background-color: #2B2D30;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
        }

        /* Start fixed datagrid header*/

        /* Update these styles in your CSS section */
        .table-container {
            position: relative;
            height: 600px; /* Set a fixed height or use calc() */
            overflow-y: auto; /* Changed from 'hidden' to 'auto' to enable scrolling */
            margin-bottom: 20px;
        }

        /* Optional: If you want to use viewport height instead */
        .table-container {
            height: calc(100vh - 250px); /* Adjust the subtracted value based on your header and other elements */
        }

            /* Ensure the table takes full width */
            .table-container table {
                width: 100%;
            }

        /* Fix for header appearance */
        table.dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #3b3f51;
        }

        /* Fix DataTables scrolling */
        .dataTables_scrollBody {
            max-height: none !important;
        }

        /* End fixed datagrid header*/
        h1 {
            color: #ffffff; /* Soft blue header text */
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

            .filter-controls label {
                font-weight: bold;
                color: #c8d1e1;
            }

            .filter-controls select,
            .filter-controls input[type="text"] {
                padding: 8px;
                border: 1px solid #3a3f54;
                border-radius: 4px;
                background-color: #3a3f54;
                color: #ffffff;
            }

            .filter-controls button {
                padding: 8px 15px;
                background-color: #3498db; /* Bright blue button */
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.3s ease;
            }

                .filter-controls button:hover {
                    background-color: #0078D7;
                }

        table.dataTable {
            background-color: #2a2d3e;
            border-collapse: collapse;
        }

            table.dataTable thead {
                background-color: #3b3f51;
                color: #ffffff;
            }

            table.dataTable th,
            table.dataTable td {
                border: 1px solid #444857;
                padding: 10px;
                color: #dcdcdc;
            }

            table.dataTable tbody tr:hover {
                background-color: #363a4a;
            }

        .dataTables_info,
        .dataTables_paginate {
            color: #c0c0c0;
        }

        .dataTables_wrapper .dataTables_filter input {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        .dataTables_wrapper .dataTables_length select {
            background-color: #3a3f54;
            color: #ffffff;
            border: 1px solid #3a3f54;
        }

        /* Scroll bar and search box fixes*/
        /* Center the search box */
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Style scrollbar for webkit browsers (Chrome, Safari, Edge) */
        .table-container::-webkit-scrollbar {
            width: 25px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #2a2d3e;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
            border: 2px solid #2a2d3e;
        }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #0078D7;
            }

        /* Style scrollbar for Firefox */
        .table-container {
            scrollbar-width: auto;
            scrollbar-color: #3498db #2a2d3e;
        }

        /* Add some spacing to the DataTables controls */
        .dataTables_wrapper .dataTables_length {
            margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 10px;
            width: 250px; /* Make search box wider */
        }

        /* Optional: Add a subtle transition effect to the scrollbar thumb */
        .table-container::-webkit-scrollbar-thumb {
            transition: background-color 0.3s ease;
        }
    </style>

</head>
<body>
    <div class="container">

        <h1><i class="fa-solid fa-scissors"></i> Diecut Inventory</h1>
        
        <!--<h1> Diecut Inventory</h1>-->

        <div class="filter-controls">
            <label for="yearSelect">Year:</label>
            <select id="yearSelect"></select>

            <label for="monthSelect">Month:</label>
            <select id="monthSelect">
                <option value="">All Months</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>

            <button id="loadDataButton">Load Data</button>                        
        </div>
        <div class="table-container">
            <div class="table-responsive">
                <table id="diecutTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Diecut ID</th>
                            <th>Customer</th>
                            <th>Description</th>
                            <th>Diecut #</th>
                            <th>Rack #</th>
                            <th>Row #</th>
                            <th>Type</th>
                            <th>Assigned Mac</th>
                            <th>Current Usage</th>
                            <th>Remarks</th>
                            <th>Status</th>     
                            <th>Date Created</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

    <script>
        let diecutDataTable;
        let currentYearFilter = new Date().getFullYear().toString(); // Default to current year
        let currentMonthFilter = ''; // Default to all months
        let selecteddiecutId = null; // Variable to store

        // Populate year dropdown
        function populateYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 25; i--) { // Last 10 years
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear; // Set default selection
        }

        // Initialize DataTables with server-side processing
        function initializeDataTable() {
            if (diecutDataTable) {
                // If table already exists, destroy it before re-initializing
                diecutDataTable.destroy();
                $('#diecutTable tbody').empty(); // Clear existing rows
            }

            diecutDataTable = $('#diecutTable').DataTable({
                processing: true, // Show processing indicator
                serverSide: true, // Enable server-side processing
                ajax: async function (data, callback, settings) {
                    // `data` object contains DataTables parameters like draw, start, length, search.value
                    console.log('DataTables AJAX request data:', data);

                    const draw = data.draw;
                    const start = data.start;
                    const length = data.length;
                    const searchValue = data.search.value; // Global search value

                    const yearToPass = currentYearFilter;
                    const monthToPass = currentMonthFilter;

                    try {
                        const jsonData = await chrome.webview.hostObjects.printcardApi.GetDiecutTable(
                            draw,
                            start,
                            length,
                            searchValue,
                            yearToPass,
                            monthToPass
                        );

                        const response = JSON.parse(jsonData);
                        console.log('First row of data:', response.data[0]);

                        if (response.error) {
                            console.error("Error from C#:", response.error);
                            alert("Error loading data: " + response.error);
                            callback({ // Return an empty dataset on error
                                draw: data.draw, 
                                recordsTotal: 0,
                                recordsFiltered: 0,
                                data: []
                            });
                            return;
                        }

                        console.log('Received data from C#:', response);

                        callback({
                            draw: data.draw,
                            recordsTotal: response.recordsTotal,
                            recordsFiltered: response.recordsFiltered,
                            data: response.data
                        });

                    } catch (e) {
                        console.error("Error calling C# or parsing JSON:", e);
                        alert("An unexpected error occurred: " + e.message);
                        callback({ // Return an empty dataset on error
                            draw: draw,
                            recordsTotal: 0,
                            recordsFiltered: 0,
                            data: []
                        });
                    }
                },
                columns: [
                    { data: 'diecutId',"visible":false},
                    { data: 'organizationName' },
                    { data: 'itemDescription' },
                    { data: 'diecutNumber' },
                    { data: 'rackNumber' },
                    { data: 'rowNumber' },
                    { data: 'diecutType' },
                    { data: 'assignedMachine' },
                    { data: 'currentUsage' },
                    { data: 'itemNotes' },
                    { data: 'itemStatus' },
                    {
                        data: 'dateCreated',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return new Date(data).toLocaleDateString();
                            }
                            return data;
                        }
                    }
                ],
                scrollY: '100%',        // Changed from true to '100%'
                scrollCollapse: true,
                paging: true,
                lengthMenu: [10, 25, 50, 100],
                pageLength: 10, // Initial page size
                searching: true, // Enable search box
                ordering: true, // Enable column ordering (DataTables will send order params to server)
                info: true, // Show "Showing X of Y entries" info
                responsive: true, // Make table responsive
                select: {
                    style: 'single',  // Allow only single row selection
                    info: false       // Don't show selected item info
                },
                // Add CSS class for selected row
                rowCallback: function (row, data, index) {
                    $(row).attr('data-diecut-id', data.diecutId);
                }
                // You might also want to implement server-side ordering (via 'order' parameter in data.order)
                // This would involve modifying your C# query to include ORDER BY based on DataTables' request.
            });
                    

        }

        // Event listener for the "Load Data" button
        document.getElementById('loadDataButton').addEventListener('click', function () {
            currentYearFilter = document.getElementById('yearSelect').value;
            currentMonthFilter = document.getElementById('monthSelect').value;
            diecutDataTable.ajax.reload(null, true); // Reload DataTables, resetting pagination
        });

        $(document).ready(function () {
            populateYearSelect();
            initializeDataTable(); // Initial load of the table
        });
        
    </script>

</body>
</html>